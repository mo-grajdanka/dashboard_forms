<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Дашборд задач: кто использовал резервную форму</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background: #fafafa; }
    h1, h2 { margin: 0.4em 0; }
    #controls { margin-bottom: 1em; }
    input, select, button { margin-right: 10px; margin-bottom: 5px; padding: 4px 6px; }
    #cards { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
    .card { flex: 1 1 140px; background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 12px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .card h3 { margin: 0; font-size: 1.4em; }
    .card span { font-size: .8em; color: #666; }
    canvas { display: block; margin: auto; }
    #trendChart, #authorChart { max-width: 100%; height: 300px; }
    #donutChart { max-width: 400px; height: 300px; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
    th { background: #f0f0f0; cursor: pointer; }
    tr.overdue { background: #ffe5e5; }
    tr.closed { background: #e9e9e9; }
    #summaryTable tbody tr:hover { background: #f9f9f9; }
    #summaryTable tbody tr.selected { background: #d0e8ff; }
  </style>
</head>
<body>
  <h1>Аналитика использования формы ✔️ Задача Б</h1>
  <div id="controls">
    <input type="file" id="fileInput" accept="application/json">
    <select id="companyFilter"><option value="">Все компании</option></select>
    <label>с <input type="date" id="startDate"></label>
    <label>по <input type="date" id="endDate"></label>
    <input type="text" id="searchText" placeholder="Поиск по тексту…" style="width:180px;">
    <button id="applyFilter" disabled>Применить</button>
    <button id="exportCsv" disabled>Экспорт CSV</button>
  </div>

  <div id="cards">
    <div class="card"><h3 id="totalCard">0</h3><span>Всего задач</span></div>
    <div class="card"><h3 id="overdueCard">0</h3><span>Просрочено</span></div>
    <div class="card"><h3 id="onTimeCard">0</h3><span>Закрыто вовремя</span></div>
  </div>

  <h2>Динамика создания задач</h2>
  <canvas id="trendChart"></canvas>

  <h2>Соотношение просрочено / вовремя</h2>
  <canvas id="donutChart"></canvas>

  <h2>Статистика по авторам</h2>
  <canvas id="authorChart"></canvas>
  <table id="summaryTable">
    <thead><tr><th>Автор</th><th>Количество</th></tr></thead>
    <tbody></tbody>
  </table>

  <h2>Детали задач <span id="detailsTitle"></span></h2>
  <table id="tasksTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Автор</th>
        <th>Ответственный</th>
        <th>Компания</th>
        <th>Срок</th>
        <th>Дата создания</th>
        <th>Просрочено на (дн.)</th>
        <th>Что сделать?</th>
        <th>Описание</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Утилиты
    const parseDate = s => {
      if (!s) return new Date(0);
      const [d, t='00:00'] = s.split(' ');
      const [day, mon, yr] = d.split('.').map(Number);
      const [hh, mm] = t.split(':').map(Number);
      return new Date(yr, mon-1, day, hh, mm);
    };
    const norm = s => (s||'').trim().replace(/\s+/g,' ').toLowerCase();
    const csvEscape = s => '"'+String(s).replace(/"/g,'""')+'"';

    let tasks = [], viewTasks = [], selectedAuthor = null;
    let trendChart, donutChart, authorChart;

    // Загрузка через файл
    document.getElementById('fileInput').addEventListener('change', e => {
      const f = e.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          tasks = JSON.parse(reader.result).map(t => {
            const due = parseDate(t['Срок']);
            const created = parseDate(t['createdAt']);
            let overdueDays = 0;
            if (t['Просрочено']==='Да' && due.getTime()>0) overdueDays = Math.ceil((new Date()-due)/864e5);
            return {...t, __createdDateObj:created, __daysOverdue:overdueDays};
          });
          initCompanyFilter();
          document.getElementById('applyFilter').disabled=false;
          document.getElementById('exportCsv').disabled=false;
          applyFilter();
        } catch { alert('Неверный формат JSON'); }
      };
      reader.readAsText(f);
    });

    document.getElementById('applyFilter').onclick = applyFilter;
    document.getElementById('exportCsv').onclick = exportCsv;

    function initCompanyFilter() {
      const comps = [...new Set(tasks.map(t=>t['Компания']).filter(Boolean))].sort();
      const sel = document.getElementById('companyFilter');
      sel.innerHTML = '<option value="">Все компании</option>' + comps.map(c=>`<option>${c}</option>`).join('');
    }

    function applyFilter() {
      const cmp = document.getElementById('companyFilter').value;
      const s = document.getElementById('startDate').value;
      const e = document.getElementById('endDate').value;
      const q = norm(document.getElementById('searchText').value);
      viewTasks = tasks.filter(t => {
        if (cmp && t['Компания']!==cmp) return false;
        const d = parseDate(t['Срок']);
        if (s && d<new Date(s)) return false;
        if (e && d>new Date(e+'T23:59:59')) return false;
        if (q && !(norm(t['Что сделать ?']).includes(q)|| norm(t['Описание задачи']).includes(q))) return false;
        return true;
      });
      updateAll();
    }

    function updateAll() { updateCards(); updateTrend(); updateDonut(); updateAuthors(); renderTasks(); }
    function updateCards() {
      const total=viewTasks.length;
      const overdue=viewTasks.filter(t=>t['Просрочено']==='Да').length;
      const onTime=viewTasks.filter(t=>t['Дата закрытия']&&t['Просрочено']==='Нет').length;
      document.getElementById('totalCard').textContent=total;
      document.getElementById('overdueCard').textContent=overdue;
      document.getElementById('onTimeCard').textContent=onTime;
    }
    function updateTrend(){
      const byDay={}; viewTasks.forEach(t=>{ const d=t.__createdDateObj; if(d.getTime()>0){ const k=d.toISOString().slice(0,10); byDay[k]=(byDay[k]||0)+1; }});
      const labels=Object.keys(byDay).sort(); const data=labels.map(k=>byDay[k]);
      if(trendChart) trendChart.destroy();
      trendChart=new Chart(document.getElementById('trendChart'),{type:'line',data:{labels,datasets:[{data,pointRadius:3}]},options:{plugins:{legend:{display:false}}}});
    }
    function updateDonut(){
      const yes=viewTasks.filter(t=>t['Просрочено']==='Да').length;
      const no=viewTasks.length-yes;
      if(donutChart) donutChart.destroy();
      donutChart=new Chart(document.getElementById('donutChart'),{type:'doughnut',data:{labels:['Просрочено','Вовремя'],datasets:[{data:[yes,no]}]},options:{plugins:{legend:{position:'bottom'}}}});
    }
    function updateAuthors(){
      const cnt={}; viewTasks.forEach(t=>{ const n=t.authorName||'Неизвестно'; cnt[n]=(cnt[n]||0)+1; });
      const entries=Object.entries(cnt).sort((a,b)=>b[1]-a[1]);
      const labels=entries.map(e=>e[0]); const values=entries.map(e=>e[1]);
      const tbody=document.querySelector('#summaryTable tbody');
      tbody.innerHTML=entries.map(([n,c])=>`<tr data-author="${n}"><td>${n}</td><td>${c}</td></tr>`).join('');
      tbody.querySelectorAll('tr').forEach(r=>r.onclick=()=>selectAuthor(r.dataset.author));
      if(authorChart) authorChart.destroy();
      authorChart=new Chart(document.getElementById('authorChart'),{type:'bar',data:{labels,datasets:[{data:values}]},options:{plugins:{legend:{display:false}}}});
    }
    function selectAuthor(a){ selectedAuthor=selectedAuthor===a?null:a; document.querySelectorAll('#summaryTable tbody tr').forEach(r=>r.classList.toggle('selected',r.dataset.author===selectedAuthor)); document.getElementById('detailsTitle').textContent=selectedAuthor?`— ${selectedAuthor}`:''; renderTasks(); }
    function renderTasks(){ const list=selectedAuthor?viewTasks.filter(t=>t.authorName===selectedAuthor):viewTasks; const tbody=document.querySelector('#tasksTable tbody'); tbody.innerHTML=list.map(t=>{ const id=t['__EMPTY']||t.ID||t.task_id||''; const cls=t['Просрочено']==='Да'?'overdue':t['Дата закрытия']?'closed':''; return `<tr class="${cls}"><td>${id}</td><td>${t.authorName||''}</td><td>${t['Ответственный [3]']||''}</td><td>${t['Компания']||''}</td><td>${t['Срок']||''}</td><td>${t['createdAt']||''}</td><td>${t.__daysOverdue||''}</td><td>${t['Что сделать ?']||''}</td><td>${t['Описание задачи']||''}</td></tr>`; }).join(''); }
    function exportCsv(tasks){ const rows=[['ID','Автор','Ответственный','Компания','Срок','Дата создания','Просрочено на (дн.)','Что сделать?','Описание']]; tasks.forEach(t=>rows.push([t['__EMPTY']||t.ID||t.task_id||'',t.authorName,t['Ответственный [3]'],t['Компания'],t['Срок'],t.createdAt||'',t.__daysOverdue||'',t['Что сделать ?'],t['Описание задачи']])); const csv=rows.map(r=>r.map(csvEscape).join(',')).join('\r\n'); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tasks.csv';a.click();URL.revokeObjectURL(a.href); }
  </script>
</body>
</html>
