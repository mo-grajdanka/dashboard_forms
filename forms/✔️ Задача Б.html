<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Дашборд задач: кто использовал резервную форму</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background: #fafafa; }
    h1, h2 { margin: 0.4em 0; }
    #controls { margin-bottom: 1em; }
    input, select, button { margin-right: 10px; margin-bottom: 5px; padding: 4px 6px; }
    #cards { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
    .card { flex: 1 1 140px; background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 12px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .card h3 { margin: 0; font-size: 1.4em; }
    .card span { font-size: .8em; color: #666; }
    canvas { display: block; margin: auto; }
    /* Увеличенная ширина для трендового графика */
    #trendChart { width: 80%; height: 300px; }
    /* Стандартная ширина для остальных диаграмм */
    #authorChart { max-width: 100%; height: 300px; }
    #donutChart { max-width: 400px; height: 300px; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
    th { background: #f0f0f0; cursor: pointer; }
    tr.overdue { background: #ffe5e5; }
    tr.closed { background: #e9e9e9; }
    #summaryTable tbody tr:hover { background: #f9f9f9; }
    #summaryTable tbody tr.selected { background: #d0e8ff; }
  </style>
</head>
<body>
  <h1>Аналитика использования формы ✔️ Задача Б</h1>
  <div id="controls">
    <input type="file" id="fileInput" accept="application/json">
    <select id="companyFilter"><option value="">Все компании</option></select>
    <label>дата создания с <input type="date" id="startDate"></label>
    <label>по <input type="date" id="endDate"></label>
    <input type="text" id="searchText" placeholder="Поиск по тексту…" style="width:180px;">
    <button id="applyFilter" disabled>Применить</button>
    <button id="exportCsv" disabled>Экспорт CSV</button>
  </div>
  <div id="cards">
    <div class="card"><h3 id="totalCard">0</h3><span>Всего задач</span></div>
    <div class="card"><h3 id="overdueCard">0</h3><span>Просрочено</span></div>
    <div class="card"><h3 id="onTimeCard">0</h3><span>Закрыто вовремя</span></div>
  </div>
  <h2>Динамика создания задач <span id="detailsTitle"></span></h2>
  <canvas id="trendChart"></canvas>
  <h2>Соотношение просрочено / вовремя</h2>
  <canvas id="donutChart"></canvas>
  <h2>Статистика по авторам</h2>
  <canvas id="authorChart"></canvas>
  <table id="summaryTable">
    <thead><tr><th>Автор</th><th>Количество</th></tr></thead>
    <tbody></tbody>
  </table>
  <h2>Детали задач</h2>
  <table id="tasksTable">
    <thead><tr><th>ID</th><th>Автор</th><th>Ответственный</th><th>Компания</th><th>Срок</th><th>Дата создания</th><th>Просрочено на (дн.)</th><th>Что сделать?</th><th>Описание</th></tr></thead>
    <tbody></tbody>
  </table>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // DOM elements
    const fileInput = document.getElementById('fileInput');
    const companyFilter = document.getElementById('companyFilter');
    const startDate = document.getElementById('startDate');
    const endDate = document.getElementById('endDate');
    const searchText = document.getElementById('searchText');
    const applyFilterBtn = document.getElementById('applyFilter');
    const exportCsvBtn = document.getElementById('exportCsv');
    const totalCard = document.getElementById('totalCard');
    const overdueCard = document.getElementById('overdueCard');
    const onTimeCard = document.getElementById('onTimeCard');
    const detailsTitle = document.getElementById('detailsTitle');
    const trendCanvas = document.getElementById('trendChart');
    const donutCanvas = document.getElementById('donutChart');
    const authorCanvas = document.getElementById('authorChart');
    const summaryBody = document.querySelector('#summaryTable tbody');
    const tasksBody = document.querySelector('#tasksTable tbody');

    // Utilities
    const parseDate = s => {
      if (!s) return new Date(0);
      const [d,t='00:00'] = s.split(' ');
      const [day,mon,yr] = d.split('.').map(Number);
      const [hh,mm] = t.split(':').map(Number);
      return new Date(yr, mon-1, day, hh, mm);
    };
    const norm = s => (s||'').trim().replace(/\s+/g,' ').toLowerCase();
    const csvEscape = s => `"${String(s).replace(/"/g,'""')}"`;

    let tasks = [], viewTasks = [], selectedAuthor = null;
    let trendChart, donutChart, authorChart;

    // Load JSON file
    fileInput.onchange = e => {
      const f = e.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          tasks = JSON.parse(reader.result).map(t => ({
            ...t,
            __createdDateObj: parseDate(t.createdAt),
            __daysOverdue: t.Просрочено==='Да' ? Math.ceil((Date.now() - parseDate(t.Срок)) / 864e5) : 0
          }));
          initFilters();
          applyFilter();
        } catch {
          alert('Неверный JSON');
        }
      };
      reader.readAsText(f);
    };

    applyFilterBtn.onclick = applyFilter;
    exportCsvBtn.onclick = () => exportCsv(viewTasks);

    function initFilters() {
      const comps = [...new Set(tasks.map(t=>t.Компания).filter(Boolean))].sort();
      companyFilter.innerHTML = '<option value="">Все компании</option>' + comps.map(c=>`<option>${c}</option>`).join('');
      applyFilterBtn.disabled = false;
      exportCsvBtn.disabled = false;
    }

    function applyFilter() {
      // console.log('applyFilter: total tasks =', tasks.length);
      const cmp = companyFilter.value;
      const start = startDate.value ? new Date(startDate.value) : null;
      const end = endDate.value ? new Date(endDate.value + 'T23:59:59') : null;
      const q = norm(searchText.value);
      // console.log('applyFilter params', {cmp, start, end, q});

      viewTasks = tasks.filter(t => {
        if (cmp && t.Компания !== cmp) return false;
        const cd = t.__createdDateObj;
        if (start && cd < start) return false;
        if (end && cd > end) return false;
        if (q && !(norm(t['Что сделать ?']).includes(q) || norm(t['Описание задачи']).includes(q))) return false;
        return true;
      });
      selectedAuthor = null;
      updateAll();
    }

    function updateAll() {
      updateCards();
      updateTrend();
      updateDonut();
      updateAuthors();
      renderTasks();
    }

    function updateCards() {
      const list = selectedAuthor
        ? viewTasks.filter(t => t.authorName === selectedAuthor)
        : viewTasks;
      // console.log('updateCards for', selectedAuthor, '->', list.length);
      totalCard.textContent = list.length;
      overdueCard.textContent = list.filter(t => t.Просрочено==='Да').length;
      onTimeCard.textContent = list.filter(t => t['Дата закрытия'] && t.Просрочено==='Нет').length;
    }

    function updateTrend() {
      const list = selectedAuthor
        ? viewTasks.filter(t => t.authorName === selectedAuthor)
        : viewTasks;
      // console.log('updateTrend for', selectedAuthor, '-> dates', list.map(t=>t.__createdDateObj));
      const byDay = {};
      list.forEach(t => {
        const d = t.__createdDateObj;
        if (d.getTime()>0) {
          const key = d.toISOString().slice(0,10);
          byDay[key] = (byDay[key]||0) + 1;
        }
      });
      const labels = Object.keys(byDay).sort();
      const data = labels.map(k => byDay[k]);
      if (trendChart) trendChart.destroy();
      trendChart = new Chart(trendCanvas, { type:'line', data:{labels,datasets:[{data,pointRadius:3}]}, options:{plugins:{legend:{display:false}}} });
      detailsTitle.textContent = selectedAuthor ? `— ${selectedAuthor}` : '';
    }

    function updateDonut() {
      const list = selectedAuthor
        ? viewTasks.filter(t => t.authorName === selectedAuthor)
        : viewTasks;
      const yes = list.filter(t=>t.Просрочено==='Да').length;
      const no = list.length - yes;
      if (donutChart) donutChart.destroy();
      donutChart = new Chart(donutCanvas, { type:'doughnut', data:{labels:['Просрочено','Вовремя'],datasets:[{data:[yes,no]}]}, options:{plugins:{legend:{position:'bottom'}}} });
    }

    function updateAuthors() {
      const cnt = {};
      viewTasks.forEach(t => { const n = t.authorName||'Неизвестно'; cnt[n] = (cnt[n]||0)+1; });
      const entries = Object.entries(cnt).sort((a,b)=>b[1]-a[1]);
      summaryBody.innerHTML = entries.map(([n,c])=>`<tr data-author="${n}"><td>${n}</td><td>${c}</td></tr>`).join('');
      summaryBody.querySelectorAll('tr').forEach(r=>r.onclick=()=>selectAuthor(r.dataset.author));
      if (authorChart) authorChart.destroy();
      const labels = entries.map(e=>e[0]);
      const values = entries.map(e=>e[1]);
      authorChart = new Chart(authorCanvas, { type:'bar', data:{labels,datasets:[{data:values}]}, options:{plugins:{legend:{display:false}}} });
    }

    function selectAuthor(a) {
      // console.log('selectAuthor', a);
      selectedAuthor = (selectedAuthor===a?null:a);
      summaryBody.querySelectorAll('tr').forEach(r=>r.classList.toggle('selected',r.dataset.author===selectedAuthor));
      updateAll();
    }

    function renderTasks() {
      const list = selectedAuthor
        ? viewTasks.filter(t=>t.authorName===selectedAuthor)
        : viewTasks;
      tasksBody.innerHTML = list.map(t=>{
        const cls = t.Просрочено==='Да'?'overdue':(t['Дата закрытия']?'closed':'');
        return `<tr class="${cls}">`+
          `<td>${t.__EMPTY||t.ID||t.task_id||''}</td>`+
          `<td>${t.authorName||''}</td>`+
          `<td>${t['Ответственный [3]']||''}</td>`+
          `<td>${t.Компания||''}</td>`+
          `<td>${t.Срок||''}</td>`+
          `<td>${t.createdAt||''}</td>`+
          `<td>${t.__daysOverdue||''}</td>`+
          `<td>${t['Что сделать ?']||''}</td>`+
          `<td>${t['Описание задачи']||''}</td>`+
        `</tr>`;
      }).join('');
    }

    function exportCsv(arr) {
      const rows = [['ID','Автор','Ответственный','Компания','Срок','Дата создания','Просрочено на (дн.)','Что сделать?','Описание']];
      arr.forEach(t=>rows.push([
        t.__EMPTY||t.ID||t.task_id||'',
        t.authorName,
        t['Ответственный [3]'],
        t.Компания,
        t.Срок,
        t.createdAt,
        t.__daysOverdue,
        t['Что сделать ?'],
        t['Описание задачи']
      ]));
      const csv = rows.map(r=>r.map(csvEscape).join(',')).join('\r\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tasks.csv'; a.click(); URL.revokeObjectURL(a.href);
    }
  </script>
</body>
</html>
